{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Account Settings</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h4>Account Information</h4>
        </div>
        <div class="card-body">
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Account Type:</strong> 
                {% if user.is_admin %}
                <span class="badge bg-success">Admin (Unlimited)</span>
                {% elif user.is_premium %}
                <span class="badge bg-primary">Premium</span>
                {% else %}
                <span class="badge bg-secondary">Free ({{ user.videos_limit }} videos/month)</span>
                {% endif %}
            </p>
            <p><strong>Videos Generated:</strong> {{ user.videos_generated }}</p>
            <button class="btn btn-sm btn-outline-warning mt-2" onclick="syncQuota()">
                ðŸ”„ Sync Quota to Actual Count
            </button>
            <small class="form-text text-muted d-block">
                If you deleted videos but your quota wasn't refunded, click to sync your counter with actual video count.
            </small>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h4>AI Script Generation</h4>
            <p class="mb-0 text-muted">Choose how scripts are generated</p>
        </div>
        <div class="card-body">
            <form method="POST">
                <div class="mb-3">
                    <label for="ai_provider" class="form-label">
                        Script Generation Method <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="ai_provider" name="ai_provider" onchange="toggleAPIFields()">
                        <option value="manual" {% if not api_keys or not api_keys.ai_provider or api_keys.ai_provider == 'manual' %}selected{% endif %}>
                            Manual (Paste from Grok/Claude) - 100% FREE âœ…
                        </option>
                        <option value="openrouter" {% if api_keys and api_keys.ai_provider == 'openrouter' %}selected{% endif %}>
                            OpenRouter (Free Gemini 2.0) - FREE
                        </option>
                        <option value="glm" {% if api_keys and api_keys.ai_provider == 'glm' %}selected{% endif %}>
                            GLM Coding Plan (Zhipu AI) - Requires Subscription
                        </option>
                        <option value="claude" {% if api_keys and api_keys.ai_provider == 'claude' %}selected{% endif %}>
                            Claude API (Best Quality) - $5/month
                        </option>
                    </select>
                    <small class="form-text text-muted">
                        <strong>Recommended:</strong> Start with Manual (free) - No API key needed!
                    </small>
                </div>

                <div id="claude_fields" style="display: none;">
                    <div class="mb-3">
                        <label for="claude_api_key" class="form-label">
                            Claude API Key
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="claude_api_key" name="claude_api_key"
                                   value="{{ api_keys.claude_api_key or '' }}" placeholder="sk-ant-api03-...">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('claude_api_key')">
                                <i class="bi bi-eye" id="claude_api_key_icon"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Get your key at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a> ($5 credit)
                        </small>
                    </div>
                </div>

                <div id="openrouter_fields" style="display: none;">
                    <div class="mb-3">
                        <label for="openrouter_api_key" class="form-label">
                            OpenRouter API Key (FREE)
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="openrouter_api_key" name="openrouter_api_key"
                                   value="{{ api_keys.openrouter_api_key or '' }}" placeholder="sk-or-...">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('openrouter_api_key')">
                                <i class="bi bi-eye" id="openrouter_api_key_icon"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Get FREE key at <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> - No credit card needed!
                        </small>
                    </div>
                </div>

                <div id="glm_fields" style="display: none;">
                    <div class="mb-3">
                        <label for="glm_api_key" class="form-label">
                            GLM Coding Plan API Key (Zhipu AI)
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="glm_api_key" name="glm_api_key"
                                   value="{{ api_keys.glm_api_key or '' }}" placeholder="Your GLM Coding API key">
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('glm_api_key')">
                                <i class="bi bi-eye" id="glm_api_key_icon"></i>
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Get your API key at <a href="https://z.ai/subscribe" target="_blank">z.ai/subscribe</a> - Requires GLM Coding Plan subscription
                        </small>
                    </div>
                </div>

                <div id="manual_info" class="alert alert-info">
                    <strong>Manual Mode:</strong> You'll paste scripts from Grok or Claude into a text box. Takes 30 seconds extra but is 100% free!
                </div>

                <hr class="my-4">

                <h5>Facebook Settings</h5>

                <!-- Facebook Token Status -->
                <div id="fb-token-status" class="mb-3">
                    <div class="alert alert-info">
                        <strong>Checking token status...</strong>
                    </div>
                </div>

                <!-- Connect Button -->
                <div class="mb-3">
                    <p class="mb-2">
                        <strong>Method 1: Connect with Facebook (Recommended)</strong>
                    </p>
                    <a href="{{ url_for('facebook_auth') }}" class="btn btn-primary btn-lg">
                        <i class="fab fa-facebook"></i> Connect Facebook Page
                    </a>
                    <small class="form-text text-muted d-block mt-2">
                        Automatically gets the correct Page Access Token with all required permissions. Valid for 60 days.
                    </small>
                </div>

                <!-- Manual Token Input (Backup) -->
                <div class="mb-3">
                    <p class="mb-2">
                        <strong>Method 2: Manual Token Entry (Advanced)</strong>
                    </p>
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#manualTokenFields">
                        Show Manual Token Input
                    </button>
                    <div class="collapse mt-3" id="manualTokenFields">
                        <div class="card card-body bg-light">
                            <div class="mb-3">
                                <label for="facebook_page_token" class="form-label">
                                    Facebook Page Access Token
                                </label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="facebook_page_token" name="facebook_page_token"
                                           value="{{ api_keys.facebook_page_token or '' }}" placeholder="EAAxxxxx...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('facebook_page_token')">
                                        <i class="bi bi-eye" id="facebook_page_token_icon"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    Make sure this is a <strong>PAGE</strong> access token, not a USER token.
                                </small>
                            </div>

                            <div class="mb-3">
                                <label for="facebook_page_id" class="form-label">
                                    Facebook Page ID
                                </label>
                                <input type="text" class="form-control" id="facebook_page_id" name="facebook_page_id"
                                       value="{{ api_keys.facebook_page_id or '' }}" placeholder="123456789">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Refresh Token Button -->
                <div class="mb-3" id="refresh-token-section" style="display: none;">
                    <button class="btn btn-success" type="button" onclick="refreshFacebookToken()">
                        Refresh Token (Extend 60 Days)
                    </button>
                    <small class="form-text text-muted">
                        Extends your token validity by 60 days. Use before it expires!
                    </small>
                </div>

                <div class="mb-3">
                    <label for="elevenlabs_api_key" class="form-label">
                        ElevenLabs API Key (Optional)
                    </label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="elevenlabs_api_key" name="elevenlabs_api_key"
                               value="{{ api_keys.elevenlabs_api_key or '' }}" placeholder="Optional for text-to-speech">
                        <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('elevenlabs_api_key')">
                            <i class="bi bi-eye" id="elevenlabs_api_key_icon"></i>
                        </button>
                    </div>
                    <small class="form-text text-muted">
                        For text-to-speech audio. Get free tier at <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a>
                    </small>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="elevenlabs_enabled" name="elevenlabs_enabled"
                           {% if api_keys.get('elevenlabs_enabled', True) %}checked{% endif %}>
                    <label class="form-check-label" for="elevenlabs_enabled">
                        <strong>Enable ElevenLabs Text-to-Speech</strong>
                    </label>
                    <small class="form-text text-muted d-block">
                        <strong>Turn this OFF to save tokens while debugging video generation</strong>. Your API key will be saved but not used until you re-enable this.
                    </small>
                </div>

                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="auto_share_to_story" name="auto_share_to_story" 
                           {% if api_keys.auto_share_to_story %}checked{% endif %}>
                    <label class="form-check-label" for="auto_share_to_story">
                        <strong>Automatically share Reels to Story</strong>
                    </label>
                    <small class="form-text text-muted d-block">
                        Each Reel will be automatically posted to your Facebook Story after publishing
                    </small>
                </div>

                <button type="submit" class="btn btn-primary">Save Settings</button>
            </form>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5>ðŸ”— Setup Guides</h5>
        </div>
        <div class="card-body">
            <h6>Claude API Key:</h6>
            <ol class="small">
                <li>Go to <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></li>
                <li>Sign up and add $5 credit</li>
                <li>Create API key and copy it here</li>
            </ol>

            <h6 class="mt-3">GLM Coding Plan (Zhipu AI):</h6>
            <ol class="small">
                <li>Subscribe to GLM Coding Plan at <a href="https://z.ai/subscribe" target="_blank">z.ai/subscribe</a></li>
                <li>Get your API key from the dashboard</li>
                <li>Copy your API key and paste it here</li>
                <li><strong>Note:</strong> Uses the coding endpoint - optimized for code generation</li>
            </ol>

            <h6 class="mt-3">Facebook API Setup:</h6>
            <ol class="small">
                <li>Go to <a href="https://developers.facebook.com" target="_blank">developers.facebook.com</a></li>
                <li>Create App â†’ Business type</li>
                <li>Add "Facebook Login" product</li>
                <li>Get Page Access Token with permissions: pages_manage_posts, pages_read_engagement</li>
                <li>Find your Page ID in your Facebook Page settings â†’ About</li>
            </ol>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function toggleAPIFields() {
    const provider = document.getElementById('ai_provider').value;

    const claudeFields = document.getElementById('claude_fields');
    const openrouterFields = document.getElementById('openrouter_fields');
    const glmFields = document.getElementById('glm_fields');
    const manualInfo = document.getElementById('manual_info');

    if (claudeFields) claudeFields.style.display = (provider === 'claude') ? 'block' : 'none';
    if (openrouterFields) openrouterFields.style.display = (provider === 'openrouter') ? 'block' : 'none';
    if (glmFields) glmFields.style.display = (provider === 'glm') ? 'block' : 'none';
    if (manualInfo) manualInfo.style.display = (provider === 'manual') ? 'block' : 'none';
}

function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');

    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

function checkFacebookToken() {
    fetch('/facebook/check-token')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('fb-token-status');
            const refreshSection = document.getElementById('refresh-token-section');

            if (!data.valid) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <strong>Not Connected</strong><br>
                        ${data.error || 'No Facebook token found. Please connect your Facebook Page.'}
                    </div>
                `;
                refreshSection.style.display = 'none';
            } else {
                const typeBadge = data.type === 'PAGE' ?
                    '<span class="badge bg-success">PAGE Token (Correct!)</span>' :
                    '<span class="badge bg-warning">USER Token (Wrong!)</span>';

                const daysLeft = data.days_left || 0;
                let expiryClass = 'success';
                if (daysLeft < 7) expiryClass = 'danger';
                else if (daysLeft < 30) expiryClass = 'warning';

                statusDiv.innerHTML = `
                    <div class="alert alert-${expiryClass} mb-0">
                        <strong>Connected: ${data.page_name || 'Facebook Page'}</strong><br>
                        Page ID: ${data.page_id}<br>
                        Token Type: ${typeBadge}<br>
                        Expires in: <strong>${daysLeft} days</strong><br>
                        Permissions: ${data.scopes ? data.scopes.join(', ') : 'N/A'}
                    </div>
                `;

                if (data.type === 'PAGE' && days_left > 0) {
                    refreshSection.style.display = 'block';
                } else {
                    refreshSection.style.display = 'none';
                }

                if (data.type !== 'PAGE') {
                    statusDiv.innerHTML += `
                        <div class="alert alert-warning mt-2 mb-0">
                            <strong>Warning:</strong> You have a USER token instead of a PAGE token.
                            Posting will fail! Click "Connect Facebook Page" above to fix this.
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error checking token:', error);
            document.getElementById('fb-token-status').innerHTML = `
                <div class="alert alert-secondary mb-0">
                    Unable to check token status. Refresh the page.
                </div>
            `;
        });
}

function refreshFacebookToken() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'Refreshing...';
    btn.disabled = true;

    fetch('/facebook/refresh-token', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            btn.innerHTML = 'Refreshed!';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
                checkFacebookToken();
            }, 2000);
        } else {
            btn.innerHTML = 'Failed';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
            alert(data.error || 'Failed to refresh token');
        }
    })
    .catch(error => {
        btn.innerHTML = 'Error';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }, 2000);
        alert('Error refreshing token');
    });
}

function syncQuota() {
    if (!confirm('Sync your quota counter to match the actual number of videos in your account?\n\nThis will recount your videos and update your quota accordingly.')) {
        return;
    }

    fetch('/sync-quota', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Failed to sync quota');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error syncing quota');
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleAPIFields();
    checkFacebookToken();
});
</script>
{% endblock %}